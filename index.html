<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Très Cozy Flashcards</title>
        <!-- Google Fonts for the chosen typography -->
        <link
            href="https://fonts.googleapis.com/css2?family=Vollkorn:wght@400;700&family=Libre+Baskerville:wght@400;700&family=Cabin:wght@400;700&display=swap"
            rel="stylesheet"
        />

        <style>
            /* --- GLOBAL STYLES & VARIABLES --- */
            :root {
                --bg-color: #fdfaf6; /* Creamy white */
                --header-bg: #fffaf0; /* Slightly warmer white */
                --card-bg: #ffffff; /* Card background */
                --card-back-bg: #fdf6eb; /* Slightly different back color */
                --input-bg: #ffffff; /* Form input background */
                --text-color: #5d5d5d; /* Soft taupe */
                --text-color-muted: #888; /* Lighter text for secondary info */
                --heading-color: #4a4a4a; /* Darker accent for headings */
                --border-color: #e0ddd7; /* Muted accent border */
                --shadow-light: 0 2px 4px rgba(0, 0, 0, 0.05);
                --shadow-medium: 0 6px 12px rgba(0, 0, 0, 0.08);
                --shadow-heavy: 0 10px 20px rgba(0, 0, 0, 0.12);
                --accent-color-1: #d3a77a; /* Croissant */
                --accent-color-2: #8cb3c0; /* Travel */
                --danger-color: #d9534f; /* Muted red */
                --success-color: #5cb85c; /* Muted green */
                --hover-bg-danger: #fceae9;
                --hover-bg-edit: #e3eef2;
            }

            .dark-mode:root {
                --bg-color: #2c2c2c;
                --header-bg: #3a3a3a;
                --card-bg: #3a3a3a;
                --card-back-bg: #4a4a4a;
                --input-bg: #4a4a4a;
                --text-color: #e0e0e0;
                --text-color-muted: #a0a0a0;
                --heading-color: #ffffff;
                --border-color: #5d5d5d;
                --accent-color-1: #e0c09a;
                --accent-color-2: #a8d8e0;
                --danger-color: #e08a87;
                --success-color: #8ce08c;
                --hover-bg-danger: rgba(224, 138, 135, 0.2);
                --hover-bg-edit: rgba(168, 216, 224, 0.2);
            }

            body {
                font-family: "Vollkorn", serif;
                background-color: var(--bg-color);
                color: var(--text-color);
                margin: 0;
                line-height: 1.6;
                transition: background-color 0.3s ease, color 0.3s ease; /* Smooth transition */
            }

            h1,
            h2,
            h3 {
                font-family: "Libre Baskerville", serif;
                color: var(--heading-color);
            }

            .hidden {
                display: none !important;
            }

            main {
                padding: 40px 20px;
                max-width: 1200px;
                margin: auto;
            }

            /* --- HEADER & FOOTER --- */
            header,
            footer {
                text-align: center;
                padding: 25px 20px;
                background-color: var(--header-bg);
                border-bottom: 1px solid var(--border-color);
                transition: background-color 0.3s ease, border-color 0.3s ease; /* Smooth transition */
            }
            header {
                position: relative;
            }
            footer {
                border-bottom: none;
                border-top: 1px solid var(--border-color);
                margin-top: 50px;
                color: var(--text-color-muted);
                font-size: 0.9em;
            }
            .logo svg text {
                fill: var(
                    --heading-color
                ); /* Use variable for logo text color */
            }
            .logo svg {
                vertical-align: middle;
            }

            /* --- UTILITY & BUTTONS --- */
            .btn {
                background: none;
                border: 2px solid var(--border-color);
                border-radius: 50px;
                padding: 12px 25px;
                cursor: pointer;
                display: inline-flex;
                align-items: center;
                justify-content: center;
                gap: 10px;
                font-size: 1.1em;
                font-family: "Cabin", sans-serif;
                color: var(--text-color);
                transition: all 0.2s ease-in-out;
                box-shadow: var(--shadow-light);
                text-decoration: none;
                white-space: nowrap;
            }
            .btn svg {
                width: 20px;
                height: 20px;
            }
            .btn:hover {
                transform: translateY(-2px);
                box-shadow: var(--shadow-medium);
            }
            .btn-primary {
                background-color: var(--accent-color-1);
                border-color: var(--accent-color-1);
                color: white;
            }
            .btn-danger {
                border-color: var(--danger-color);
                color: var(--danger-color);
            }
            .btn-danger svg {
                stroke: var(--danger-color);
            }
            .btn-success {
                border-color: var(--success-color);
                color: var(--success-color);
            }
            .btn-success svg {
                stroke: var(--success-color);
            }

            .theme-toggle-btn {
                position: absolute;
                top: 50%;
                right: 20px;
                transform: translateY(-50%);
                padding: 8px;
                border-radius: 50%;
                width: 44px;
                height: 44px;
            }

            /* --- DASHBOARD VIEW --- */
            .dashboard-header {
                text-align: center;
                margin-bottom: 50px;
            }
            .dashboard-header h2 {
                font-size: 2.5em;
                margin-bottom: 10px;
            }
            .dashboard-header p {
                font-size: 1.1em;
                color: var(--text-color-muted);
            }
            .deck-container {
                display: flex;
                flex-wrap: wrap;
                justify-content: center;
                gap: 30px;
            }
            .deck-card {
                border: 2px solid var(--border-color);
                border-radius: 12px;
                width: 220px;
                padding: 25px;
                text-align: center;
                background-color: var(--card-bg);
                box-shadow: var(--shadow-medium);
                cursor: pointer;
                transition: transform 0.2s ease-in-out,
                    box-shadow 0.2s ease-in-out;
            }
            .deck-card:hover {
                transform: translateY(-5px);
                box-shadow: var(--shadow-heavy);
            }
            .deck-card svg {
                width: 60px;
                height: 60px;
                margin-bottom: 15px;
            }
            .deck-card h3 {
                margin: 10px 0 5px 0;
                font-size: 1.5em;
            }
            .deck-card p {
                margin: 0;
                font-family: "Cabin", sans-serif;
                color: var(--text-color-muted);
            }

            /* --- FLASHCARD VIEW --- */
            .flashcard-view {
                max-width: 600px;
                margin: auto;
            }
            .flashcard-container {
                perspective: 1000px;
                height: 300px;
                cursor: pointer;
            }
            .flashcard {
                position: relative;
                width: 100%;
                height: 100%;
                transform-style: preserve-3d;
                transition: transform 0.6s ease-in-out;
            }
            .flashcard.is-flipped {
                transform: rotateY(180deg);
            }

            .card-front,
            .card-back {
                position: absolute;
                width: 100%;
                height: 100%;
                backface-visibility: hidden;
                display: flex;
                flex-direction: column;
                justify-content: center;
                align-items: center;
                text-align: center;
                border: 2px solid var(--border-color);
                border-radius: 15px;
                background-color: var(--card-bg);
                box-shadow: var(--shadow-medium);
                padding: 20px;
                box-sizing: border-box;
                overflow: hidden;
            }
            .card-back {
                transform: rotateY(180deg);
                background-color: var(--card-back-bg);
            }
            .card-front h2,
            .card-back h2 {
                font-family: "Libre Baskerville", serif;
                font-size: 2.2em;
                margin: 0;
            }
            .card-back p {
                margin-top: 15px;
                font-family: "Cabin", sans-serif;
                font-size: 1.2em;
                color: var(--text-color);
            }

            /* --- ANIMATIONS FOR NEXT/PREVIOUS WORD --- */
            @keyframes slideOutLeft {
                from {
                    transform: translateX(0);
                    opacity: 1;
                }
                to {
                    transform: translateX(-100%);
                    opacity: 0;
                }
            }
            @keyframes slideInRight {
                from {
                    transform: translateX(100%);
                    opacity: 0;
                }
                to {
                    transform: translateX(0);
                    opacity: 1;
                }
            }
            @keyframes slideOutRight {
                from {
                    transform: translateX(0);
                    opacity: 1;
                }
                to {
                    transform: translateX(100%);
                    opacity: 0;
                }
            }
            @keyframes slideInLeft {
                from {
                    transform: translateX(-100%);
                    opacity: 0;
                }
                to {
                    transform: translateX(0);
                    opacity: 1;
                }
            }

            .slide-out-left {
                animation: slideOutLeft 0.5s forwards;
            }
            .slide-in-right {
                animation: slideInRight 0.5s forwards;
            }
            .slide-out-right {
                animation: slideOutRight 0.5s forwards;
            }
            .slide-in-left {
                animation: slideInLeft 0.5s forwards;
            }

            .flashcard-controls {
                display: flex;
                justify-content: center;
                gap: 20px;
                margin-top: 40px;
            }
            .navigation-controls {
                margin-top: 40px;
                text-align: center;
            }

            /* --- MANAGE WORDS VIEW --- */
            .manage-view-container {
                max-width: 800px;
                margin: auto;
                background-color: var(--card-bg);
                padding: 30px 40px;
                border-radius: 12px;
                box-shadow: var(--shadow-medium);
                border: 1px solid var(--border-color);
            }
            .manage-view-container h2 {
                text-align: center;
                margin-top: 0;
                margin-bottom: 30px;
            }

            #add-category-form {
                display: flex;
                gap: 15px;
                margin-bottom: 20px;
                align-items: stretch;
            }
            #category-input {
                flex-grow: 1;
            }
            .section-divider {
                border: 0;
                height: 1px;
                background-color: var(--border-color);
                margin: 40px 0;
            }

            #add-word-form,
            #edit-word-form {
                display: flex;
                flex-direction: column;
                gap: 15px;
            }
            .form-group {
                display: flex;
                flex-direction: column;
            }
            .form-group label {
                margin-bottom: 8px;
                font-weight: bold;
                font-family: "Cabin", sans-serif;
                color: var(--text-color);
            }
            #word-input,
            #definition-input,
            #image-url-input,
            #category-input,
            #category-select,
            #edit-word-input,
            #edit-definition-input,
            #edit-image-url-input {
                padding: 12px;
                border: 2px solid var(--border-color);
                border-radius: 8px;
                font-size: 1rem;
                font-family: "Vollkorn", serif;
                transition: border-color 0.2s;
                background-color: var(--input-bg);
                color: var(--text-color); /* Ensure input text is visible */
                box-sizing: border-box;
                width: 100%;
            }

            .select-wrapper {
                position: relative;
                width: 100%;
            }

            .select-wrapper::after {
                content: "";
                position: absolute;
                top: 50%;
                right: 15px;
                width: 0;
                height: 0;
                border-left: 6px solid transparent;
                border-right: 6px solid transparent;
                border-top: 6px solid var(--text-color);
                transform: translateY(-50%);
                pointer-events: none;
            }

            #category-select,
            #edit-category-select {
                -webkit-appearance: none;
                -moz-appearance: none;
                appearance: none;
                padding-right: 40px;
            }

            #word-input:focus,
            #definition-input:focus,
            #image-url-input:focus,
            #category-input:focus,
            #category-select:focus,
            #edit-word-input:focus,
            #edit-definition-input:focus,
            #edit-image-url-input:focus {
                outline: none;
                border-color: var(--accent-color-1);
            }
            #definition-input,
            #edit-definition-input {
                resize: vertical;
                min-height: 80px;
            }

            .data-management {
                margin-top: 30px;
                padding-top: 20px;
                border-top: 1px solid var(--border-color);
                display: flex;
                gap: 15px;
                justify-content: center;
                flex-wrap: wrap;
            }
            #import-file-input {
                display: none;
            }

            #category-list-container {
                margin-top: 40px;
            }
            .category-item {
                border: 1px solid var(--border-color);
                border-radius: 8px;
                margin-bottom: 25px;
                background-color: var(--card-back-bg);
            }
            .category-header {
                padding: 15px 20px;
                background-color: var(--header-bg);
                border-bottom: 1px solid var(--border-color);
                display: flex;
                justify-content: space-between;
                align-items: center;
                border-top-left-radius: 8px;
                border-top-right-radius: 8px;
            }
            .category-header h3 {
                margin: 0;
                font-size: 1.4em;
            }
            .category-header .review-star-svg {
                width: 20px;
                height: 20px;
                margin-right: 10px;
                fill: var(--accent-color-1);
            }
            .word-list {
                list-style-type: none;
                padding: 0;
                margin: 0;
                max-height: 40vh;
                overflow-y: auto;
            }
            .word-list li {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 15px 20px;
                border-bottom: 1px solid var(--border-color);
            }
            .word-list li:last-child {
                border-bottom: none;
            }
            .word-actions {
                display: flex;
                align-items: center;
                gap: 5px;
            }

            .word-content {
                flex-grow: 1;
                padding-right: 15px;
            }
            .word-content strong {
                font-size: 1.2em;
                font-family: "Libre Baskerville", serif;
                color: var(--heading-color);
                display: block;
            }
            .word-content p {
                font-size: 1rem;
                color: var(--text-color);
                margin: 5px 0 0 0;
                word-break: break-word;
            }

            .word-content .image-url-display {
                font-size: 0.85em;
                color: var(--text-color-muted);
                margin-top: 8px;
                font-style: italic;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
                max-width: 400px;
            }

            .word-list-image {
                max-width: 100px;
                max-height: 60px;
                border-radius: 4px;
                margin-top: 10px;
                object-fit: cover;
            }

            .delete-btn,
            .edit-btn {
                background: none;
                border: none;
                cursor: pointer;
                padding: 5px;
                border-radius: 50%;
                flex-shrink: 0;
                transition: background-color 0.2s;
            }
            .delete-btn:hover {
                background-color: var(--hover-bg-danger);
            }
            .delete-btn svg {
                stroke: var(--danger-color);
            }
            .edit-btn:hover {
                background-color: var(--hover-bg-edit);
            }
            .edit-btn svg {
                stroke: var(--accent-color-2);
            }

            /* MODAL STYLES */
            .modal-overlay {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.6);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 1000;
                opacity: 0;
                transition: opacity 0.3s ease;
                pointer-events: none;
            }
            .modal-overlay.active {
                opacity: 1;
                pointer-events: auto;
            }
            .modal-content {
                background: var(--bg-color);
                padding: 30px 40px;
                border-radius: 12px;
                box-shadow: var(--shadow-heavy);
                width: 90%;
                max-width: 500px;
                transform: scale(0.9);
                transition: transform 0.3s ease;
            }
            .modal-overlay.active .modal-content {
                transform: scale(1);
            }
            .modal-header {
                text-align: center;
                margin-bottom: 25px;
            }
            .modal-actions {
                display: flex;
                justify-content: flex-end;
                gap: 15px;
                margin-top: 25px;
            }

            #edit-image-preview-container {
                margin-top: 15px;
            }
            #edit-image-preview {
                max-width: 100%;
                max-height: 150px;
                border-radius: 8px;
                object-fit: cover;
                border: 2px solid var(--border-color);
            }

            #csv-editor-container {
                margin-top: 40px;
            }
            #csv-textarea {
                width: 100%;
                padding: 12px;
                border: 2px solid var(--border-color);
                border-radius: 8px;
                font-size: 0.95rem;
                font-family: Consolas, "Courier New", monospace;
                resize: vertical;
                box-sizing: border-box;
                background-color: var(--card-back-bg);
                color: var(--text-color);
                line-height: 1.5;
            }
            #csv-textarea:focus {
                outline: none;
                border-color: var(--accent-color-1);
            }
            .csv-editor-actions {
                display: flex;
                justify-content: flex-end;
                gap: 15px;
                margin-top: 20px;
            }
        </style>
    </head>
    <body>
        <header>
            <div class="logo">
                <svg
                    xmlns="http://www.w3.org/2000/svg"
                    viewBox="0 0 200 50"
                    width="150"
                    height="37.5"
                >
                    <title>Très Cozy Flashcards Logo</title>
                    <text
                        x="5"
                        y="35"
                        font-family="Libre Baskerville, serif"
                        font-size="30"
                    >
                        Très Cozy
                    </text>
                    <path
                        d="M165 15 L170 25 L180 27 L170 29 L165 39 L160 29 L150 27 L160 25 Z"
                        fill="#f0c040"
                    />
                </svg>
            </div>
            <button class="btn theme-toggle-btn" id="theme-toggle">
                <svg
                    xmlns="http://www.w3.org/2000/svg"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                >
                    <title>Toggle Theme</title>
                    <path
                        d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"
                    ></path>
                </svg>
            </button>
        </header>

        <main>
            <!-- 1. DASHBOARD VIEW -->
            <section id="dashboard-view">
                <div class="dashboard-header">
                    <h2>My Decks</h2>
                    <p>Choose a category to review, or manage your words.</p>
                </div>
                <div class="deck-container" id="deck-container">
                    <!-- Review Words Deck will be inserted here by JavaScript -->
                    <article class="deck-card" id="manage-words-deck">
                        <svg
                            xmlns="http://www.w3.org/2000/svg"
                            viewBox="0 0 24 24"
                            fill="none"
                            stroke="currentColor"
                            stroke-width="2"
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            style="stroke: var(--accent-color-1)"
                        >
                            <title>Manage icon</title>
                            <path
                                d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"
                            ></path>
                            <path
                                d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"
                            ></path>
                        </svg>
                        <h3>Manage Words</h3>
                        <p id="manage-word-count">0 words</p>
                    </article>
                </div>
            </section>

            <!-- 2. FLASHCARD VIEW -->
            <section id="flashcard-view" class="hidden">
                <h2
                    id="flashcard-category-title"
                    style="text-align: center"
                ></h2>
                <div class="flashcard-container">
                    <div class="flashcard" id="flashcard">
                        <div class="card-front">
                            <h2 id="card-front-text"></h2>
                        </div>
                        <div class="card-back">
                            <img
                                id="card-back-image"
                                src=""
                                alt="Flashcard Image"
                                style="
                                    display: none;
                                    max-width: 90%;
                                    max-height: 120px;
                                    border-radius: 8px;
                                    margin-bottom: 15px;
                                    object-fit: cover;
                                "
                            />
                            <h2 id="card-back-word"></h2>
                            <p id="card-back-definition"></p>
                        </div>
                    </div>
                </div>

                <div class="flashcard-controls">
                    <button class="btn" id="prev-word-btn">
                        <svg
                            xmlns="http://www.w3.org/2000/svg"
                            viewBox="0 0 24 24"
                            fill="none"
                            stroke="currentColor"
                            stroke-width="2"
                            stroke-linecap="round"
                            stroke-linejoin="round"
                        >
                            <title>Previous card icon</title>
                            <polyline points="15 18 9 12 15 6"></polyline>
                        </svg>
                        <span>Previous</span>
                    </button>
                    <button class="btn" id="send-to-review-btn">
                        <svg
                            xmlns="http://www.w3.org/2000/svg"
                            viewBox="0 0 24 24"
                            fill="none"
                            stroke="currentColor"
                            stroke-width="2"
                            stroke-linecap="round"
                            stroke-linejoin="round"
                        >
                            <title>Send to review icon</title>
                            <polygon
                                points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"
                            ></polygon>
                        </svg>
                        <span>Send to Review</span>
                    </button>
                    <button class="btn btn-primary" id="next-word-btn">
                        <span>Next Word</span>
                        <svg
                            xmlns="http://www.w3.org/2000/svg"
                            viewBox="0 0 24 24"
                            fill="none"
                            stroke="currentColor"
                            stroke-width="2"
                            stroke-linecap="round"
                            stroke-linejoin="round"
                        >
                            <title>Next card icon</title>
                            <polyline points="9 18 15 12 9 6"></polyline>
                        </svg>
                    </button>
                </div>
                <div class="navigation-controls">
                    <button class="btn" id="back-to-dashboard-flashcard">
                        Back to Dashboard
                    </button>
                </div>
            </section>

            <!-- 3. MANAGE WORDS VIEW -->
            <section id="manage-view" class="hidden">
                <div class="manage-view-container">
                    <h2>Manage Categories</h2>
                    <form id="add-category-form">
                        <div class="form-group" style="flex-grow: 1; margin: 0">
                            <label for="category-input" class="hidden"
                                >Category Name</label
                            >
                            <input
                                type="text"
                                id="category-input"
                                placeholder="e.g., Culinary Words"
                                required
                            />
                        </div>
                        <button type="submit" class="btn btn-primary">
                            Add Category
                        </button>
                    </form>

                    <hr class="section-divider" />

                    <h2>Manage Words</h2>
                    <form id="add-word-form">
                        <div class="form-group">
                            <label for="category-select">Category</label>
                            <div class="select-wrapper">
                                <select id="category-select" required></select>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="word-input">Word</label>
                            <input
                                type="text"
                                id="word-input"
                                placeholder="e.g., Manger"
                                required
                            />
                        </div>
                        <div class="form-group">
                            <label for="definition-input">Definition</label>
                            <textarea
                                id="definition-input"
                                placeholder="e.g., To eat"
                                required
                            ></textarea>
                        </div>
                        <div class="form-group">
                            <label for="image-url-input"
                                >Image URL (Optional)</label
                            >
                            <input
                                type="url"
                                id="image-url-input"
                                placeholder="e.g., https://example.com/image.png"
                            />
                        </div>
                        <button type="submit" class="btn btn-primary">
                            Add Word
                        </button>
                    </form>

                    <div id="category-list-container"></div>

                    <div class="data-management">
                        <button id="export-btn" class="btn">
                            Export to CSV
                        </button>
                        <button id="show-csv-btn" class="btn">Show CSV</button>
                        <label for="import-file-input" class="btn"
                            >Import from CSV</label
                        >
                        <input
                            type="file"
                            id="import-file-input"
                            accept=".csv"
                        />
                    </div>
                    <div id="csv-editor-container" class="hidden">
                        <hr class="section-divider" />
                        <h2>Edit Raw CSV Data</h2>
                        <div class="form-group">
                            <label for="csv-textarea">CSV Content</label>
                            <textarea id="csv-textarea" rows="15"></textarea>
                        </div>
                        <div class="csv-editor-actions">
                            <button id="discard-csv-changes-btn" class="btn">
                                Discard Changes
                            </button>
                            <button
                                id="save-csv-changes-btn"
                                class="btn btn-primary"
                            >
                                Save Changes
                            </button>
                        </div>
                    </div>
                </div>
                <div class="navigation-controls">
                    <button class="btn" id="back-to-dashboard-manage">
                        Back to Dashboard
                    </button>
                </div>
            </section>

            <div id="edit-word-modal" class="modal-overlay">
                <div class="modal-content">
                    <div class="modal-header">
                        <h2>Edit Word</h2>
                    </div>
                    <form id="edit-word-form">
                        <input type="hidden" id="edit-word-id" />
                        <div class="form-group">
                            <label for="edit-word-input">Word</label>
                            <input type="text" id="edit-word-input" required />
                        </div>
                        <div class="form-group">
                            <label for="edit-definition-input"
                                >Definition</label
                            >
                            <textarea
                                id="edit-definition-input"
                                required
                            ></textarea>
                        </div>
                        <div class="form-group">
                            <label for="edit-image-url-input"
                                >Image URL (Optional)</label
                            >
                            <input type="url" id="edit-image-url-input" />
                        </div>
                        <div id="edit-image-preview-container" class="hidden">
                            <img
                                id="edit-image-preview"
                                src=""
                                alt="Image Preview"
                            />
                        </div>
                        <div class="modal-actions">
                            <button
                                type="button"
                                id="cancel-edit-btn"
                                class="btn"
                            >
                                Cancel
                            </button>
                            <button type="submit" class="btn btn-primary">
                                Save Changes
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </main>

        <footer>
            <p>from Yohannes, with love ❤️</p>
        </footer>

        <script>
            document.addEventListener("DOMContentLoaded", () => {
                // --- STATE AND CONSTANTS ---
                const STORAGE_KEY = "tresCozyFlashcardsData";
                const REVIEW_CATEGORY_NAME = "Review Words"; // Centralized name for the special category

                let data = {
                    categories: [],
                    words: [],
                };

                let currentReviewWords = [];
                let reviewHistory = [];
                let currentWord = null;

                // --- DOM ELEMENT REFERENCES ---
                const dashboardView = document.getElementById("dashboard-view");
                const flashcardView = document.getElementById("flashcard-view");
                const manageView = document.getElementById("manage-view");
                const themeToggleButton =
                    document.getElementById("theme-toggle");

                const deckContainer = document.getElementById("deck-container");
                const manageWordsDeck =
                    document.getElementById("manage-words-deck");
                const manageWordCount =
                    document.getElementById("manage-word-count");

                const flashcardCategoryTitle = document.getElementById(
                    "flashcard-category-title"
                );
                const flashcard = document.getElementById("flashcard");
                const cardFrontText =
                    document.getElementById("card-front-text");
                const cardBackWord = document.getElementById("card-back-word");
                const cardBackDefinition = document.getElementById(
                    "card-back-definition"
                );
                const nextWordBtn = document.getElementById("next-word-btn");
                const prevWordBtn = document.getElementById("prev-word-btn");
                const sendToReviewBtn =
                    document.getElementById("send-to-review-btn");
                const cardBackImage =
                    document.getElementById("card-back-image");

                const backToDashboardFlashcard = document.getElementById(
                    "back-to-dashboard-flashcard"
                );
                const backToDashboardManage = document.getElementById(
                    "back-to-dashboard-manage"
                );

                const addCategoryForm =
                    document.getElementById("add-category-form");
                const categoryInput = document.getElementById("category-input");
                const categorySelect =
                    document.getElementById("category-select");
                const categoryListContainer = document.getElementById(
                    "category-list-container"
                );

                const addWordForm = document.getElementById("add-word-form");
                const wordInput = document.getElementById("word-input");
                const definitionInput =
                    document.getElementById("definition-input");
                const imageUrlInput =
                    document.getElementById("image-url-input");

                const exportBtn = document.getElementById("export-btn");
                const importFileInput =
                    document.getElementById("import-file-input");

                const editWordModal =
                    document.getElementById("edit-word-modal");
                const editWordForm = document.getElementById("edit-word-form");
                const editWordId = document.getElementById("edit-word-id");
                const editWordInput =
                    document.getElementById("edit-word-input");
                const editDefinitionInput = document.getElementById(
                    "edit-definition-input"
                );
                const editImageUrlInput = document.getElementById(
                    "edit-image-url-input"
                );
                const cancelEditBtn =
                    document.getElementById("cancel-edit-btn");
                const editImagePreviewContainer = document.getElementById(
                    "edit-image-preview-container"
                );
                const editImagePreview =
                    document.getElementById("edit-image-preview");

                const showCsvBtn = document.getElementById("show-csv-btn");
                const csvEditorContainer = document.getElementById(
                    "csv-editor-container"
                );
                const csvTextarea = document.getElementById("csv-textarea");
                const saveCsvChangesBtn = document.getElementById(
                    "save-csv-changes-btn"
                );
                const discardCsvChangesBtn = document.getElementById(
                    "discard-csv-changes-btn"
                );

                // --- VIEW MANAGEMENT ---
                const showView = (viewToShow) => {
                    [dashboardView, flashcardView, manageView].forEach((view) =>
                        view.classList.add("hidden")
                    );
                    viewToShow.classList.remove("hidden");
                };

                // --- THEME TOGGLE ---
                const toggleTheme = () => {
                    document.documentElement.classList.toggle("dark-mode");
                };
                themeToggleButton.addEventListener("click", toggleTheme);

                // --- CSV HELPER FUNCTIONS ---
                function escapeCsvField(field) {
                    if (field == null) field = "";
                    field = String(field);
                    const needsQuotes =
                        field.includes(",") ||
                        field.includes('"') ||
                        field.includes("\n") ||
                        field.includes("\r");
                    const escapedField = field.replace(/"/g, '""');
                    return needsQuotes ? `"${escapedField}"` : escapedField;
                }

                function dataToCsv() {
                    const header = "category,word,definition,image";

                    // Ensure "Review Words" category comes first if it exists
                    const sortedCategories = [...data.categories].sort(
                        (a, b) => {
                            if (a.name === REVIEW_CATEGORY_NAME) return -1;
                            if (b.name === REVIEW_CATEGORY_NAME) return 1;
                            return 0; // Maintain original order for others
                        }
                    );

                    let lines = [];
                    sortedCategories.forEach((category) => {
                        data.words
                            .filter((word) => word.categoryId === category.id)
                            .forEach((word) => {
                                lines.push(
                                    `${escapeCsvField(
                                        category.name
                                    )},${escapeCsvField(
                                        word.word
                                    )},${escapeCsvField(
                                        word.definition
                                    )},${escapeCsvField(word.image)}`
                                );
                            });
                    });

                    return [header, ...lines].join("\n");
                }

                function csvToData(csvString) {
                    const lines = csvString
                        .split(/\r?\n/)
                        .filter((line) => line.trim() !== "");
                    if (lines.length === 0)
                        return { categories: [], words: [] };

                    const headerLine = lines[0]
                        .toLowerCase()
                        .trim()
                        .replace(/['"]+/g, "");
                    const hasHeader =
                        headerLine.includes("category") &&
                        headerLine.includes("word") &&
                        headerLine.includes("definition");

                    if (hasHeader) {
                        lines.shift(); // Remove header line
                    }

                    const newData = { categories: [], words: [] };
                    const categoryMap = new Map();

                    lines.forEach((line) => {
                        const fields =
                            line.match(/(".*?"|[^",]+)(?=\s*,|\s*$)/g) || [];
                        const cleanFields = fields.map((field) =>
                            field.replace(/^"|"$/g, "").replace(/""/g, '"')
                        );

                        const [catName, word, definition, imageUrl] =
                            cleanFields;

                        if (catName && word && definition) {
                            let categoryId;
                            if (categoryMap.has(catName)) {
                                categoryId = categoryMap.get(catName);
                            } else {
                                const newCategory = {
                                    id: crypto.randomUUID(),
                                    name: catName,
                                };
                                newData.categories.push(newCategory);
                                categoryId = newCategory.id;
                                categoryMap.set(catName, categoryId);
                            }

                            newData.words.push({
                                id: crypto.randomUUID(),
                                categoryId: categoryId,
                                word: word,
                                definition: definition,
                                image: imageUrl || "",
                                createdAt: new Date().toISOString(),
                            });
                        }
                    });
                    return newData;
                }

                // --- CORE DATA FUNCTIONS ---
                const saveData = () => {
                    localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
                    renderAll();
                };

                const loadData = () => {
                    const storedData = localStorage.getItem(STORAGE_KEY);
                    if (storedData) {
                        data = JSON.parse(storedData);
                    }
                };

                // --- RENDER FUNCTIONS ---
                const renderDashboard = () => {
                    const count = data.words.length;
                    manageWordCount.textContent = `${count} ${
                        count === 1 ? "word" : "words"
                    }`;

                    // Clear existing decks
                    const allDecks = deckContainer.querySelectorAll(
                        ".category-deck, .review-deck"
                    );
                    allDecks.forEach((deck) => deck.remove());

                    let reviewCategory = null;
                    const otherCategories = [];

                    data.categories.forEach((category) => {
                        if (category.name === REVIEW_CATEGORY_NAME) {
                            reviewCategory = category;
                        } else {
                            otherCategories.push(category);
                        }
                    });

                    // Render Review Words deck first if it exists
                    if (reviewCategory) {
                        const wordsInCategory = data.words.filter(
                            (w) => w.categoryId === reviewCategory.id
                        );
                        const wordCount = wordsInCategory.length;
                        if (wordCount > 0) {
                            const deck = document.createElement("article");
                            deck.className = "deck-card review-deck"; // Special class
                            deck.dataset.categoryId = reviewCategory.id;
                            deck.innerHTML = `
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="var(--accent-color-1)" stroke="var(--accent-color-1)" stroke-width="1" stroke-linecap="round" stroke-linejoin="round">
                                    <title>Review Words Deck</title>
                                    <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon>
                                </svg>
                                <h3>${reviewCategory.name}</h3>
                                <p>${wordCount} ${
                                wordCount === 1 ? "word" : "words"
                            }</p>
                            `;
                            deckContainer.insertBefore(deck, manageWordsDeck);
                        }
                    }

                    // Render other category decks
                    otherCategories.forEach((category) => {
                        const wordsInCategory = data.words.filter(
                            (w) => w.categoryId === category.id
                        );
                        const wordCount = wordsInCategory.length;

                        const deck = document.createElement("article");
                        deck.className = "deck-card category-deck";
                        deck.dataset.categoryId = category.id;
                        deck.innerHTML = `
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="stroke: var(--accent-color-2)">
                                <title>Card icon</title>
                                <rect x="2" y="7" width="20" height="14" rx="2" ry="2"></rect>
                                <path d="M16 2H8C6.9 2 6 2.9 6 4v3h12V4c0-1.1-.9-2-2-2z"></path>
                            </svg>
                            <h3>${category.name}</h3>
                            <p>${wordCount} ${
                            wordCount === 1 ? "word" : "words"
                        }</p>
                        `;
                        deckContainer.insertBefore(deck, manageWordsDeck);
                    });
                };

                const renderManageView = () => {
                    categorySelect.innerHTML = "";
                    if (data.categories.length === 0) {
                        const option = document.createElement("option");
                        option.textContent = "Please create a category first";
                        option.disabled = true;
                        option.selected = true;
                        categorySelect.appendChild(option);
                    } else {
                        // Separate and sort categories for the dropdown
                        const reviewCat = data.categories.find(
                            (c) => c.name === REVIEW_CATEGORY_NAME
                        );
                        const otherCats = data.categories.filter(
                            (c) => c.name !== REVIEW_CATEGORY_NAME
                        );

                        if (reviewCat) {
                            const option = document.createElement("option");
                            option.value = reviewCat.id;
                            option.textContent = reviewCat.name;
                            categorySelect.appendChild(option);
                        }
                        otherCats.forEach((cat) => {
                            const option = document.createElement("option");
                            option.value = cat.id;
                            option.textContent = cat.name;
                            categorySelect.appendChild(option);
                        });
                    }

                    categoryListContainer.innerHTML = "";
                    if (data.categories.length === 0) {
                        categoryListContainer.innerHTML = `<p style="text-align:center; color:#888;">No categories yet. Add one above to get started!</p>`;
                        return;
                    }

                    // Separate and sort categories for the list view
                    const reviewCatList = data.categories.find(
                        (c) => c.name === REVIEW_CATEGORY_NAME
                    );
                    const otherCatsList = data.categories.filter(
                        (c) => c.name !== REVIEW_CATEGORY_NAME
                    );
                    const sortedCategoriesForList = reviewCatList
                        ? [reviewCatList, ...otherCatsList]
                        : otherCatsList;

                    sortedCategoriesForList.forEach((category) => {
                        const wordsInCategory = data.words.filter(
                            (word) => word.categoryId === category.id
                        );
                        const categoryItem = document.createElement("div");
                        categoryItem.className = "category-item";
                        const isReviewCategory =
                            category.name === REVIEW_CATEGORY_NAME;

                        let wordListHtml = '<ul class="word-list">';
                        if (wordsInCategory.length > 0) {
                            wordsInCategory.forEach((word) => {
                                const imageHtml = word.image
                                    ? `<img src="${word.image}" alt="${word.word}" class="word-list-image">`
                                    : "";
                                wordListHtml += `
                                    <li>
                                        <div class="word-content">
                                            <strong>${word.word}</strong>
                                            <p>${word.definition}</p>
                                            ${imageHtml}
                                        </div>
                                        <div class="word-actions">
                                            <button class="edit-btn" data-word-id="${word.id}"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><title>Edit word</title><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg></button>
                                            <button class="delete-btn" data-word-id="${word.id}"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><title>Delete word</title><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg></button>
                                        </div>
                                    </li>
                                `;
                            });
                        } else {
                            wordListHtml += `<li><p style="color:#888; padding-left: 5px;">This category is empty.</p></li>`;
                        }
                        wordListHtml += "</ul>";

                        const deleteButtonHtml =
                            wordsInCategory.length === 0
                                ? `
                            <button class="delete-btn delete-category-btn" data-category-id="${category.id}" title="Delete this empty category">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><title>Delete category</title><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                            </button>`
                                : "";

                        const reviewStarIcon = isReviewCategory
                            ? `
                            <svg class="review-star-svg" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                                <title>Review Category</title>
                                <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon>
                            </svg>`
                            : "";

                        categoryItem.innerHTML = `
                             <div class="category-header">
                                <div style="display: flex; align-items: center;">
                                    ${reviewStarIcon}
                                    <h3>${category.name}</h3>
                                </div>
                                ${deleteButtonHtml}
                            </div>
                            ${wordListHtml}
                        `;
                        categoryListContainer.appendChild(categoryItem);
                    });
                };

                const renderAll = () => {
                    renderDashboard();
                    renderManageView();
                };

                const updateCard = (word) => {
                    flashcard.classList.remove("is-flipped");
                    cardFrontText.textContent = word.word;
                    cardBackWord.textContent = word.word;
                    cardBackDefinition.textContent = word.definition;
                    sendToReviewBtn.disabled =
                        word.categoryName === REVIEW_CATEGORY_NAME;

                    if (word.image && word.image.trim() !== "") {
                        cardBackImage.src = word.image;
                        cardBackImage.style.display = "block";
                        cardBackImage.onerror = () => {
                            cardBackImage.style.display = "none";
                        };
                    } else {
                        cardBackImage.src = "";
                        cardBackImage.style.display = "none";
                    }
                };

                const showNextCard = () => {
                    if (currentReviewWords.length === 0) {
                        cardFrontText.textContent = "No Words";
                        cardBackWord.textContent = "This category is empty";
                        cardBackDefinition.textContent =
                            "Please add some words to this category in the 'Manage Words' section.";
                        cardBackImage.style.display = "none";
                        sendToReviewBtn.disabled = true; // Disable if no words
                        return;
                    }

                    flashcard.classList.add("slide-out-left");

                    setTimeout(() => {
                        if (currentWord) {
                            reviewHistory.push(currentWord);
                            if (reviewHistory.length > 3) {
                                reviewHistory.shift();
                            }
                        }

                        // Remove the current word from the pool to avoid immediate repeats
                        const currentWordIndex = currentReviewWords.findIndex(
                            (w) =>
                                w.id === (currentWord ? currentWord.id : null)
                        );
                        if (currentWordIndex > -1) {
                            currentReviewWords.splice(currentWordIndex, 1);
                        }

                        // If all words have been seen, reset the pool
                        if (currentReviewWords.length === 0) {
                            const originalCategory = data.categories.find(
                                (c) =>
                                    c.name ===
                                    flashcardCategoryTitle.textContent.replace(
                                        "Reviewing: ",
                                        ""
                                    )
                            );
                            if (originalCategory) {
                                currentReviewWords = data.words.filter(
                                    (w) => w.categoryId === originalCategory.id
                                );
                            }
                        }

                        const randomIndex = Math.floor(
                            Math.random() * currentReviewWords.length
                        );
                        currentWord = currentReviewWords[randomIndex];
                        updateCard(currentWord);

                        flashcard.classList.remove("slide-out-left");
                        flashcard.classList.add("slide-in-right");

                        prevWordBtn.disabled = reviewHistory.length === 0;

                        setTimeout(() => {
                            flashcard.classList.remove("slide-in-right");
                        }, 500);
                    }, 500);
                };

                const showPreviousCard = () => {
                    if (reviewHistory.length > 0) {
                        flashcard.classList.add("slide-out-right");

                        setTimeout(() => {
                            if (currentWord) {
                                // Add current word back to the review pool if it's not already there
                                if (
                                    !currentReviewWords.find(
                                        (w) => w.id === currentWord.id
                                    )
                                ) {
                                    currentReviewWords.push(currentWord);
                                }
                            }
                            currentWord = reviewHistory.pop();
                            updateCard(currentWord);

                            flashcard.classList.remove("slide-out-right");
                            flashcard.classList.add("slide-in-left");

                            setTimeout(() => {
                                flashcard.classList.remove("slide-in-left");
                            }, 500);
                        }, 500);
                    }
                    prevWordBtn.disabled = reviewHistory.length === 0;
                };

                // --- EVENT HANDLERS ---
                const handleSendToReview = () => {
                    if (!currentWord) return;

                    let reviewCategory = data.categories.find(
                        (c) => c.name === REVIEW_CATEGORY_NAME
                    );

                    // If "Review Words" category doesn't exist, create it
                    if (!reviewCategory) {
                        reviewCategory = {
                            id: crypto.randomUUID(),
                            name: REVIEW_CATEGORY_NAME,
                        };
                        // Add it to the beginning of the categories array to ensure it's first in the CSV
                        data.categories.unshift(reviewCategory);
                    }

                    // Find the word in the main data array and update its categoryId
                    const wordIndex = data.words.findIndex(
                        (w) => w.id === currentWord.id
                    );
                    if (wordIndex > -1) {
                        data.words[wordIndex].categoryId = reviewCategory.id;
                        saveData();
                    }

                    // Visually update button and then move to next card
                    sendToReviewBtn.disabled = true;
                    alert(
                        `"${currentWord.word}" has been sent to the Review Words deck.`
                    );
                    showNextCard();
                };

                const handleAddCategory = (event) => {
                    event.preventDefault();
                    const categoryName = categoryInput.value.trim();
                    if (categoryName === "") {
                        alert("Category name cannot be empty.");
                        return;
                    }
                    if (
                        data.categories.some(
                            (cat) =>
                                cat.name.toLowerCase() ===
                                categoryName.toLowerCase()
                        )
                    ) {
                        alert("A category with this name already exists.");
                        return;
                    }
                    const newCategory = {
                        id: crypto.randomUUID(),
                        name: categoryName,
                    };
                    data.categories.push(newCategory);
                    saveData();
                    addCategoryForm.reset();
                };

                const handleAddWord = (event) => {
                    event.preventDefault();
                    const categoryId = categorySelect.value;
                    const wordText = wordInput.value.trim();
                    const definitionText = definitionInput.value.trim();
                    const imageUrl = imageUrlInput.value.trim();

                    if (
                        !categoryId ||
                        categorySelect.options[categorySelect.selectedIndex]
                            .disabled
                    ) {
                        alert("Please select a valid category.");
                        return;
                    }
                    if (wordText === "" || definitionText === "") {
                        alert("Word and definition cannot be empty.");
                        return;
                    }

                    const newWord = {
                        id: crypto.randomUUID(),
                        categoryId: categoryId,
                        word: wordText,
                        definition: definitionText,
                        image: imageUrl,
                        createdAt: new Date().toISOString(),
                    };
                    data.words.unshift(newWord);
                    saveData();
                    addWordForm.reset();
                    categorySelect.value = categoryId;
                    wordInput.focus();
                };

                const handleListClick = (event) => {
                    const deleteBtn = event.target.closest(".delete-btn");
                    const editBtn = event.target.closest(".edit-btn");
                    const deleteCategoryBtn = event.target.closest(
                        ".delete-category-btn"
                    );

                    if (deleteCategoryBtn) {
                        const categoryId =
                            deleteCategoryBtn.getAttribute("data-category-id");
                        if (
                            confirm(
                                "Are you sure you want to delete this empty category?"
                            )
                        ) {
                            data.categories = data.categories.filter(
                                (cat) => cat.id !== categoryId
                            );
                            saveData();
                        }
                    } else if (deleteBtn) {
                        const wordId = deleteBtn.getAttribute("data-word-id");
                        data.words = data.words.filter(
                            (word) => word.id !== wordId
                        );
                        saveData();
                    } else if (editBtn) {
                        const wordId = editBtn.getAttribute("data-word-id");
                        openEditModal(wordId);
                    }
                };

                const handleExport = () => {
                    if (data.words.length === 0) {
                        alert("Nothing to export.");
                        return;
                    }
                    const csvString = dataToCsv();
                    const blob = new Blob([csvString], { type: "text/csv" });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement("a");
                    a.href = url;
                    a.download = `tres_cozy_words_${new Date()
                        .toISOString()
                        .slice(0, 10)}.csv`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                };

                const handleImport = (event) => {
                    const file = event.target.files[0];
                    if (!file) return;
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const importedData = csvToData(e.target.result);
                            data = importedData;
                            saveData();
                            alert(
                                `Successfully imported ${importedData.words.length} words into ${importedData.categories.length} categories! Existing data has been replaced.`
                            );
                        } catch (error) {
                            alert(`Error importing file: ${error.message}`);
                        } finally {
                            importFileInput.value = "";
                        }
                    };
                    reader.onerror = () => alert("Error reading file.");
                    reader.readAsText(file);
                };

                const handleDeckClick = (event) => {
                    const deck = event.target.closest(
                        ".category-deck, .review-deck"
                    );
                    if (deck) {
                        reviewHistory = [];
                        currentWord = null;

                        const categoryId = deck.dataset.categoryId;
                        const category = data.categories.find(
                            (c) => c.id === categoryId
                        );
                        currentReviewWords = data.words.filter(
                            (w) => w.categoryId === categoryId
                        );

                        flashcardCategoryTitle.textContent = `Reviewing: ${category.name}`;
                        showView(flashcardView);
                        showNextCard();
                    }
                };

                const openEditModal = (wordId) => {
                    const wordToEdit = data.words.find(
                        (word) => word.id === wordId
                    );
                    if (wordToEdit) {
                        editWordId.value = wordToEdit.id;
                        editWordInput.value = wordToEdit.word;
                        editDefinitionInput.value = wordToEdit.definition;
                        editImageUrlInput.value = wordToEdit.image || "";
                        if (wordToEdit.image) {
                            editImagePreview.src = wordToEdit.image;
                            editImagePreviewContainer.classList.remove(
                                "hidden"
                            );
                        } else {
                            editImagePreviewContainer.classList.add("hidden");
                        }
                        editWordModal.classList.add("active");
                    }
                };

                const closeEditModal = () => {
                    editWordModal.classList.remove("active");
                };

                const handleUpdateWord = (event) => {
                    event.preventDefault();
                    const wordId = editWordId.value;
                    const updatedWord = editWordInput.value.trim();
                    const updatedDefinition = editDefinitionInput.value.trim();
                    const updatedImageUrl = editImageUrlInput.value.trim();

                    if (updatedWord === "" || updatedDefinition === "") {
                        alert("Word and definition cannot be empty.");
                        return;
                    }

                    const wordIndex = data.words.findIndex(
                        (word) => word.id === wordId
                    );
                    if (wordIndex > -1) {
                        data.words[wordIndex].word = updatedWord;
                        data.words[wordIndex].definition = updatedDefinition;
                        data.words[wordIndex].image = updatedImageUrl;
                        saveData();
                        closeEditModal();
                    }
                };

                // --- NAVIGATION EVENT LISTENERS ---
                deckContainer.addEventListener("click", handleDeckClick);
                manageWordsDeck.addEventListener("click", () =>
                    showView(manageView)
                );
                [backToDashboardFlashcard, backToDashboardManage].forEach(
                    (btn) => {
                        btn.addEventListener("click", () =>
                            showView(dashboardView)
                        );
                    }
                );

                // --- FUNCTIONAL EVENT LISTENERS ---
                flashcard.addEventListener("click", () =>
                    flashcard.classList.toggle("is-flipped")
                );
                nextWordBtn.addEventListener("click", (e) => {
                    e.stopPropagation();
                    showNextCard();
                });
                prevWordBtn.addEventListener("click", (e) => {
                    e.stopPropagation();
                    showPreviousCard();
                });
                sendToReviewBtn.addEventListener("click", handleSendToReview); // New event listener
                addCategoryForm.addEventListener("submit", handleAddCategory);
                addWordForm.addEventListener("submit", handleAddWord);
                categoryListContainer.addEventListener(
                    "click",
                    handleListClick
                );
                exportBtn.addEventListener("click", handleExport);
                importFileInput.addEventListener("change", handleImport);
                editWordForm.addEventListener("submit", handleUpdateWord);
                cancelEditBtn.addEventListener("click", closeEditModal);
                editWordModal.addEventListener("click", (event) => {
                    if (event.target === editWordModal) closeEditModal();
                });
                editImageUrlInput.addEventListener("input", () => {
                    const url = editImageUrlInput.value.trim();
                    if (url) {
                        editImagePreview.src = url;
                        editImagePreviewContainer.classList.remove("hidden");
                    } else {
                        editImagePreviewContainer.classList.add("hidden");
                    }
                });

                showCsvBtn.addEventListener("click", () => {
                    csvTextarea.value = dataToCsv();
                    csvEditorContainer.classList.remove("hidden");
                });
                discardCsvChangesBtn.addEventListener("click", () => {
                    csvTextarea.value = "";
                    csvEditorContainer.classList.add("hidden");
                });
                saveCsvChangesBtn.addEventListener("click", () => {
                    if (
                        !confirm(
                            "Are you sure? This will overwrite your current data."
                        )
                    )
                        return;
                    try {
                        const newData = csvToData(csvTextarea.value);
                        if (
                            !newData ||
                            !Array.isArray(newData.words) ||
                            !Array.isArray(newData.categories)
                        ) {
                            throw new Error("Invalid CSV structure.");
                        }
                        data = newData;
                        saveData();
                        csvEditorContainer.classList.add("hidden");
                        alert(
                            `Successfully updated: ${data.words.length} words in ${data.categories.length} categories.`
                        );
                    } catch (error) {
                        alert(
                            `Failed to save. Check CSV format.\nError: ${error.message}`
                        );
                    }
                });

                // --- INITIALIZATION ---
                loadData();
                renderAll();
                showView(dashboardView);
            });
        </script>
    </body>
</html>
