<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Tr√®s Cozy Flashcards</title>
        <!-- Google Fonts for the chosen typography -->
        <link
            href="https://fonts.googleapis.com/css2?family=Vollkorn:wght@400;700&family=Libre+Baskerville:wght@400;700&family=Cabin:wght@400;700&display=swap"
            rel="stylesheet"
        />
        <style>
            /* --- GLOBAL STYLES & VARIABLES --- */
            :root {
                --bg-color: #fdfaf6; /* Creamy white */
                --header-bg: #fffaf0; /* Slightly warmer white */
                --card-bg: #fffaf0; /* Warm card background */
                --card-back-bg: #fdf6eb; /* Slightly different back color */
                --text-color: #5d5d5d; /* Soft taupe */
                --heading-color: #4a4a4a; /* Darker accent for headings */
                --border-color: #e0ddd7; /* Muted accent border */
                --shadow-light: 0 2px 4px rgba(0, 0, 0, 0.05);
                --shadow-medium: 0 6px 12px rgba(0, 0, 0, 0.08);
                --shadow-heavy: 0 10px 20px rgba(0, 0, 0, 0.12);
                --accent-color-1: #d3a77a; /* Croissant */
                --accent-color-2: #8cb3c0; /* Travel */
                --danger-color: #d9534f; /* Muted red */
                --success-color: #5cb85c; /* Muted green */
            }

            body {
                font-family: "Vollkorn", serif;
                background-color: var(--bg-color);
                color: var(--text-color);
                margin: 0;
                line-height: 1.6;
            }

            h1,
            h2,
            h3 {
                font-family: "Libre Baskerville", serif;
                color: var(--heading-color);
            }

            .hidden {
                display: none !important;
            }

            main {
                padding: 40px 20px;
                max-width: 1200px;
                margin: auto;
            }

            /* --- HEADER & FOOTER --- */
            header,
            footer {
                text-align: center;
                padding: 25px 20px;
                background-color: var(--header-bg);
                border-bottom: 1px solid var(--border-color);
            }
            footer {
                border-bottom: none;
                border-top: 1px solid var(--border-color);
                margin-top: 50px;
                color: #8b8b8b;
                font-size: 0.9em;
            }
            .logo svg {
                vertical-align: middle;
            }

            /* --- UTILITY & BUTTONS --- */
            .btn {
                background: none;
                border: 2px solid var(--border-color);
                border-radius: 50px;
                padding: 12px 25px;
                cursor: pointer;
                display: inline-flex;
                align-items: center;
                justify-content: center;
                gap: 10px;
                font-size: 1.1em;
                font-family: "Cabin", sans-serif;
                color: var(--text-color);
                transition: all 0.2s ease-in-out;
                box-shadow: var(--shadow-light);
                text-decoration: none;
                white-space: nowrap;
            }
            .btn:hover {
                transform: translateY(-2px);
                box-shadow: var(--shadow-medium);
            }
            .btn-primary {
                background-color: var(--accent-color-1);
                border-color: var(--accent-color-1);
                color: white;
            }
            .btn-danger {
                border-color: var(--danger-color);
                color: var(--danger-color);
            }
            .btn-danger svg {
                stroke: var(--danger-color);
            }
            .btn-success {
                border-color: var(--success-color);
                color: var(--success-color);
            }
            .btn-success svg {
                stroke: var(--success-color);
            }

            /* --- DASHBOARD VIEW --- */
            .dashboard-header {
                text-align: center;
                margin-bottom: 50px;
            }
            .dashboard-header h2 {
                font-size: 2.5em;
                margin-bottom: 10px;
            }
            .dashboard-header p {
                font-size: 1.1em;
                color: #7b7b7b;
            }
            .deck-container {
                display: flex;
                flex-wrap: wrap;
                justify-content: center;
                gap: 30px;
            }
            .deck-card {
                border: 2px solid var(--border-color);
                border-radius: 12px;
                width: 220px;
                padding: 25px;
                text-align: center;
                background-color: #ffffff;
                box-shadow: var(--shadow-medium);
                cursor: pointer;
                transition: transform 0.2s ease-in-out,
                    box-shadow 0.2s ease-in-out;
            }
            .deck-card:hover {
                transform: translateY(-5px);
                box-shadow: var(--shadow-heavy);
            }
            .deck-card svg {
                width: 60px;
                height: 60px;
                margin-bottom: 15px;
            }
            .deck-card h3 {
                margin: 10px 0 5px 0;
                font-size: 1.5em;
            }
            .deck-card p {
                margin: 0;
                font-family: "Cabin", sans-serif;
                color: #888;
            }

            /* --- FLASHCARD VIEW --- */
            .flashcard-view {
                max-width: 600px;
                margin: auto;
            }
            .flashcard-container {
                perspective: 1000px;
                height: 300px;
                cursor: pointer;
            }
            .flashcard {
                position: relative;
                width: 100%;
                height: 100%;
                transform-style: preserve-3d;
                transition: transform 0.6s ease-in-out;
            }
            .flashcard.is-flipped {
                transform: rotateY(180deg);
            }

            .card-front,
            .card-back {
                position: absolute;
                width: 100%;
                height: 100%;
                backface-visibility: hidden;
                display: flex;
                flex-direction: column;
                justify-content: center;
                align-items: center;
                text-align: center;
                border: 2px solid var(--border-color);
                border-radius: 15px;
                background-color: var(--card-bg);
                box-shadow: var(--shadow-medium);
                padding: 20px;
                box-sizing: border-box;
            }
            .card-back {
                transform: rotateY(180deg);
                background-color: var(--card-back-bg);
            }
            .card-front h2,
            .card-back h2 {
                font-family: "Libre Baskerville", serif;
                font-size: 2.2em;
                margin: 0;
            }
            .card-back p {
                margin-top: 15px;
                font-family: "Cabin", sans-serif;
                font-size: 1.2em;
                color: var(--text-color);
            }

            .flashcard-controls {
                display: flex;
                justify-content: center;
                gap: 20px;
                margin-top: 40px;
            }
            .navigation-controls {
                margin-top: 40px;
                text-align: center;
            }

            /* --- MANAGE WORDS VIEW --- */
            .manage-view-container {
                max-width: 800px;
                margin: auto;
                background-color: white;
                padding: 30px 40px;
                border-radius: 12px;
                box-shadow: var(--shadow-medium);
                border: 1px solid var(--border-color);
            }
            .manage-view-container h2 {
                text-align: center;
                margin-top: 0;
                margin-bottom: 30px;
            }

            #add-category-form {
                display: flex;
                gap: 15px;
                margin-bottom: 20px;
                align-items: stretch;
            }
            #category-input {
                flex-grow: 1;
            }
            .section-divider {
                border: 0;
                height: 1px;
                background-color: var(--border-color);
                margin: 40px 0;
            }

            #add-word-form {
                display: flex;
                flex-direction: column;
                gap: 15px;
            }
            .form-group {
                display: flex;
                flex-direction: column;
            }
            .form-group label {
                margin-bottom: 8px;
                font-weight: bold;
                font-family: "Cabin", sans-serif;
                color: #555;
            }
            #word-input,
            #definition-input,
            #category-input,
            #category-select {
                padding: 12px;
                border: 2px solid var(--border-color);
                border-radius: 8px;
                font-size: 1rem;
                font-family: "Vollkorn", serif;
                transition: border-color 0.2s;
                background-color: white;
                /* NEW: Added for consistency */
                box-sizing: border-box;
                width: 100%;
            }

            /* NEW: Wrapper for custom select arrow */
            .select-wrapper {
                position: relative;
                width: 100%;
            }

            /* NEW: Custom arrow for the select dropdown */
            .select-wrapper::after {
                content: "";
                position: absolute;
                top: 50%;
                right: 15px;
                width: 0;
                height: 0;
                border-left: 6px solid transparent;
                border-right: 6px solid transparent;
                border-top: 6px solid var(--text-color);
                transform: translateY(-50%);
                pointer-events: none; /* Allows clicks to pass through */
            }

            /* NEW: Remove default arrow and add padding for custom arrow */
            #category-select {
                -webkit-appearance: none;
                -moz-appearance: none;
                appearance: none;
                padding-right: 40px; /* Make space for the arrow */
            }

            #word-input:focus,
            #definition-input:focus,
            #category-input:focus,
            #category-select:focus {
                outline: none;
                border-color: var(--accent-color-1);
            }
            #definition-input {
                resize: vertical;
                min-height: 80px;
            }

            .data-management {
                margin-top: 30px;
                padding-top: 20px;
                border-top: 1px solid var(--border-color);
                display: flex;
                gap: 15px;
                justify-content: center;
                flex-wrap: wrap;
            }
            #import-file-input {
                display: none;
            }

            #category-list-container {
                margin-top: 40px;
            }
            .category-item {
                border: 1px solid var(--border-color);
                border-radius: 8px;
                margin-bottom: 25px;
                background-color: #fdfdfb;
            }
            .category-header {
                padding: 15px 20px;
                background-color: var(--header-bg);
                border-bottom: 1px solid var(--border-color);
                display: flex;
                justify-content: space-between;
                align-items: center;
                border-top-left-radius: 8px;
                border-top-right-radius: 8px;
            }
            .category-header h3 {
                margin: 0;
                font-size: 1.4em;
            }

            .word-list {
                list-style-type: none;
                padding: 0;
                margin: 0;
                max-height: 40vh;
                overflow-y: auto;
            }
            .word-list li {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 15px 20px;
                border-bottom: 1px solid var(--border-color);
            }
            .word-list li:last-child {
                border-bottom: none;
            }

            .word-content {
                flex-grow: 1;
                padding-right: 15px;
            }
            .word-content strong {
                font-size: 1.2em;
                font-family: "Libre Baskerville", serif;
                color: var(--heading-color);
                display: block;
            }
            .word-content p {
                font-size: 1rem;
                color: var(--text-color);
                margin: 5px 0 0 0;
                word-break: break-word;
            }

            .delete-btn {
                background: none;
                border: none;
                cursor: pointer;
                padding: 5px;
                border-radius: 50%;
                flex-shrink: 0;
                transition: background-color 0.2s;
            }
            .delete-btn:hover {
                background-color: #fceae9;
            }
            .delete-btn svg {
                stroke: var(--danger-color);
            }
        </style>
    </head>
    <body>
        <header>
            <div class="logo">
                <svg
                    xmlns="http://www.w3.org/2000/svg"
                    viewBox="0 0 200 50"
                    width="150"
                    height="37.5"
                >
                    <title>Tr√®s Cozy Flashcards Logo</title>
                    <text
                        x="5"
                        y="35"
                        font-family="Libre Baskerville, serif"
                        font-size="30"
                        fill="#4a4a4a"
                    >
                        Tr√®s Cozy
                    </text>
                    <path
                        d="M165 15 L170 25 L180 27 L170 29 L165 39 L160 29 L150 27 L160 25 Z"
                        fill="#f0c040"
                    />
                </svg>
            </div>
        </header>

        <main>
            <!-- 1. DASHBOARD VIEW -->
            <section id="dashboard-view">
                <div class="dashboard-header">
                    <h2>My Decks</h2>
                    <p>Choose a category to review, or manage your words.</p>
                </div>
                <div class="deck-container" id="deck-container">
                    <article class="deck-card" id="manage-words-deck">
                        <svg
                            xmlns="http://www.w3.org/2000/svg"
                            viewBox="0 0 24 24"
                            fill="none"
                            stroke="currentColor"
                            stroke-width="2"
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            style="stroke: var(--accent-color-1)"
                        >
                            <title>Manage icon</title>
                            <path
                                d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"
                            ></path>
                            <path
                                d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"
                            ></path>
                        </svg>
                        <h3>Manage Words</h3>
                        <p id="manage-word-count">0 words</p>
                    </article>
                </div>
            </section>

            <!-- 2. FLASHCARD VIEW -->
            <section id="flashcard-view" class="hidden">
                <h2
                    id="flashcard-category-title"
                    style="text-align: center"
                ></h2>
                <div class="flashcard-container">
                    <div class="flashcard" id="flashcard">
                        <div class="card-front">
                            <h2 id="card-front-text"></h2>
                        </div>
                        <div class="card-back">
                            <div>
                                <h2 id="card-back-word"></h2>
                                <p id="card-back-definition"></p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="flashcard-controls">
                    <button class="btn btn-danger" id="next-word-btn">
                        <svg
                            xmlns="http://www.w3.org/2000/svg"
                            viewBox="0 0 24 24"
                            fill="none"
                            stroke-width="2"
                            stroke-linecap="round"
                            stroke-linejoin="round"
                        >
                            <title>Next card icon</title>
                            <polyline points="9 18 15 12 9 6"></polyline>
                        </svg>
                        <span>Next Word</span>
                    </button>
                </div>
                <div class="navigation-controls">
                    <button class="btn" id="back-to-dashboard-flashcard">
                        Back to Dashboard
                    </button>
                </div>
            </section>

            <!-- 3. MANAGE WORDS VIEW -->
            <section id="manage-view" class="hidden">
                <div class="manage-view-container">
                    <h2>Manage Categories</h2>
                    <form id="add-category-form">
                        <div class="form-group" style="flex-grow: 1; margin: 0">
                            <label for="category-input" class="hidden"
                                >Category Name</label
                            >
                            <input
                                type="text"
                                id="category-input"
                                placeholder="e.g., Culinary Words"
                                required
                            />
                        </div>
                        <button type="submit" class="btn btn-primary">
                            Add Category
                        </button>
                    </form>

                    <hr class="section-divider" />

                    <h2>Manage Words</h2>
                    <form id="add-word-form">
                        <div class="form-group">
                            <label for="category-select">Category</label>
                            <div class="select-wrapper">
                                <select id="category-select" required></select>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="word-input">Word</label>
                            <input
                                type="text"
                                id="word-input"
                                placeholder="e.g., Manger"
                                required
                            />
                        </div>
                        <div class="form-group">
                            <label for="definition-input">Definition</label>
                            <textarea
                                id="definition-input"
                                placeholder="e.g., To eat"
                                required
                            ></textarea>
                        </div>
                        <button type="submit" class="btn btn-primary">
                            Add Word
                        </button>
                    </form>

                    <div id="category-list-container"></div>

                    <div class="data-management">
                        <button id="export-btn" class="btn">
                            Export "Categories -> Words -> Definition" to CSV
                        </button>
                        <label for="import-file-input" class="btn"
                            >Import "Categories -> Words -> Definition" from
                            CSV</label
                        >
                        <input
                            type="file"
                            id="import-file-input"
                            accept=".csv"
                        />
                    </div>
                </div>
                <div class="navigation-controls">
                    <button class="btn" id="back-to-dashboard-manage">
                        Back to Dashboard
                    </button>
                </div>
            </section>
        </main>

        <footer>
            <p>Learning, gently.</p>
        </footer>

        <script>
            document.addEventListener("DOMContentLoaded", () => {
                // --- STATE AND CONSTANTS ---
                const STORAGE_KEY = "tresCozyFlashcardsData"; // Updated storage key

                let data = {
                    categories: [],
                    words: [],
                };

                let currentReviewWords = [];

                // --- DOM ELEMENT REFERENCES ---
                const dashboardView = document.getElementById("dashboard-view");
                const flashcardView = document.getElementById("flashcard-view");
                const manageView = document.getElementById("manage-view");

                const deckContainer = document.getElementById("deck-container");
                const manageWordsDeck =
                    document.getElementById("manage-words-deck");
                const manageWordCount =
                    document.getElementById("manage-word-count");

                const flashcardCategoryTitle = document.getElementById(
                    "flashcard-category-title"
                );
                const flashcard = document.getElementById("flashcard");
                const cardFrontText =
                    document.getElementById("card-front-text");
                const cardBackWord = document.getElementById("card-back-word");
                const cardBackDefinition = document.getElementById(
                    "card-back-definition"
                );
                const nextWordBtn = document.getElementById("next-word-btn");

                const backToDashboardFlashcard = document.getElementById(
                    "back-to-dashboard-flashcard"
                );
                const backToDashboardManage = document.getElementById(
                    "back-to-dashboard-manage"
                );

                const addCategoryForm =
                    document.getElementById("add-category-form");
                const categoryInput = document.getElementById("category-input");
                const categorySelect =
                    document.getElementById("category-select");
                const categoryListContainer = document.getElementById(
                    "category-list-container"
                );

                const addWordForm = document.getElementById("add-word-form");
                const wordInput = document.getElementById("word-input");
                const definitionInput =
                    document.getElementById("definition-input");

                const exportBtn = document.getElementById("export-btn");
                const importFileInput =
                    document.getElementById("import-file-input");

                // --- VIEW MANAGEMENT ---
                const showView = (viewToShow) => {
                    [dashboardView, flashcardView, manageView].forEach((view) =>
                        view.classList.add("hidden")
                    );
                    viewToShow.classList.remove("hidden");
                };

                // --- CSV HELPER FUNCTIONS ---
                function escapeCsvField(field) {
                    if (field == null) field = "";
                    field = String(field);
                    const needsQuotes =
                        field.includes(",") ||
                        field.includes('"') ||
                        field.includes("\n") ||
                        field.includes("\r");
                    const escapedField = field.replace(/"/g, '""');
                    return needsQuotes ? `"${escapedField}"` : escapedField;
                }

                function dataToCsv() {
                    const header = "category,word,definition";
                    const lines = data.words.map((word) => {
                        const category = data.categories.find(
                            (cat) => cat.id === word.categoryId
                        );
                        const categoryName = category ? category.name : "";
                        return `${escapeCsvField(
                            categoryName
                        )},${escapeCsvField(word.word)},${escapeCsvField(
                            word.definition
                        )}`;
                    });
                    return [header, ...lines].join("\n");
                }

                function csvToData(csvString) {
                    const lines = csvString
                        .split(/\r?\n/)
                        .filter((line) => line.trim() !== "");
                    const headerLine =
                        lines.length > 0 ? lines[0].toLowerCase().trim() : "";

                    if (headerLine === "category,word,definition") {
                        lines.shift();
                    }

                    const newData = { categories: [], words: [] };
                    const categoryMap = new Map();

                    lines.forEach((line) => {
                        const fields =
                            line.match(/(".*?"|[^",]+)(?=\s*,|\s*$)/g) || [];
                        const cleanFields = fields.map((field) =>
                            field.replace(/^"|"$/g, "").replace(/""/g, '"')
                        );

                        const [catName, word, definition] = cleanFields;

                        if (catName && word && definition) {
                            let categoryId;
                            if (categoryMap.has(catName)) {
                                categoryId = categoryMap.get(catName);
                            } else {
                                const newCategory = {
                                    id: crypto.randomUUID(),
                                    name: catName,
                                };
                                newData.categories.push(newCategory);
                                categoryId = newCategory.id;
                                categoryMap.set(catName, categoryId);
                            }

                            newData.words.push({
                                id: crypto.randomUUID(),
                                categoryId: categoryId,
                                word: word,
                                definition: definition,
                                createdAt: new Date().toISOString(),
                            });
                        }
                    });
                    return newData;
                }

                // --- CORE DATA FUNCTIONS ---
                const saveData = () => {
                    localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
                    renderAll();
                };

                const loadData = () => {
                    const storedData = localStorage.getItem(STORAGE_KEY);
                    if (storedData) {
                        data = JSON.parse(storedData);
                    }
                };

                // --- RENDER FUNCTIONS ---
                const renderDashboard = () => {
                    const count = data.words.length;
                    manageWordCount.textContent = `${count} ${
                        count === 1 ? "word" : "words"
                    }`;

                    const categoryDecks =
                        deckContainer.querySelectorAll(".category-deck");
                    categoryDecks.forEach((deck) => deck.remove());

                    data.categories.forEach((category) => {
                        const wordsInCategory = data.words.filter(
                            (w) => w.categoryId === category.id
                        );
                        const wordCount = wordsInCategory.length;

                        const deck = document.createElement("article");
                        deck.className = "deck-card category-deck";
                        deck.dataset.categoryId = category.id;
                        deck.innerHTML = `
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="stroke: var(--accent-color-2)">
                                <title>Card icon</title>
                                <rect x="2" y="7" width="20" height="14" rx="2" ry="2"></rect>
                                <path d="M16 2H8C6.9 2 6 2.9 6 4v3h12V4c0-1.1-.9-2-2-2z"></path>
                            </svg>
                            <h3>${category.name}</h3>
                            <p>${wordCount} ${
                            wordCount === 1 ? "word" : "words"
                        }</p>
                        `;
                        deckContainer.insertBefore(deck, manageWordsDeck);
                    });
                };

                const renderManageView = () => {
                    categorySelect.innerHTML = "";
                    if (data.categories.length === 0) {
                        const option = document.createElement("option");
                        option.textContent = "Please create a category first";
                        option.disabled = true;
                        option.selected = true; // NEW: Make it selected
                        categorySelect.appendChild(option);
                    } else {
                        data.categories.forEach((cat) => {
                            const option = document.createElement("option");
                            option.value = cat.id;
                            option.textContent = cat.name;
                            categorySelect.appendChild(option);
                        });
                    }

                    categoryListContainer.innerHTML = "";
                    if (data.categories.length === 0) {
                        categoryListContainer.innerHTML = `<p style="text-align:center; color:#888;">No categories yet. Add one above to get started!</p>`;
                        return;
                    }

                    data.categories.forEach((category) => {
                        const wordsInCategory = data.words.filter(
                            (word) => word.categoryId === category.id
                        );
                        const categoryItem = document.createElement("div");
                        categoryItem.className = "category-item";

                        let wordListHtml = '<ul class="word-list">';
                        if (wordsInCategory.length > 0) {
                            wordsInCategory.forEach((word) => {
                                wordListHtml += `
                                    <li>
                                        <div class="word-content">
                                            <strong>${word.word}</strong>
                                            <p>${word.definition}</p>
                                        </div>
                                        <button class="delete-btn" data-word-id="${word.id}">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><title>Delete word</title><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                                        </button>
                                    </li>
                                `;
                            });
                        } else {
                            wordListHtml += `<li><p style="color:#888; padding-left: 5px;">This category is empty.</p></li>`;
                        }
                        wordListHtml += "</ul>";

                        categoryItem.innerHTML = `
                            <div class="category-header">
                                <h3>${category.name}</h3>
                            </div>
                            ${wordListHtml}
                        `;
                        categoryListContainer.appendChild(categoryItem);
                    });
                };

                const renderAll = () => {
                    renderDashboard();
                    renderManageView();
                };

                const showNextCard = () => {
                    flashcard.classList.remove("is-flipped");
                    if (currentReviewWords.length === 0) {
                        cardFrontText.textContent = "No Words";
                        cardBackWord.textContent = "This category is empty";
                        cardBackDefinition.textContent =
                            "Please add some words to this category in the 'Manage Words' section.";
                        return;
                    }
                    const randomIndex = Math.floor(
                        Math.random() * currentReviewWords.length
                    );
                    const currentWord = currentReviewWords[randomIndex];

                    setTimeout(() => {
                        cardFrontText.textContent = currentWord.word;
                        cardBackWord.textContent = currentWord.word;
                        cardBackDefinition.textContent = currentWord.definition;
                    }, 150);
                };

                // --- EVENT HANDLERS ---
                const handleAddCategory = (event) => {
                    event.preventDefault();
                    const categoryName = categoryInput.value.trim();
                    if (categoryName === "") {
                        alert("Category name cannot be empty.");
                        return;
                    }
                    if (
                        data.categories.some(
                            (cat) =>
                                cat.name.toLowerCase() ===
                                categoryName.toLowerCase()
                        )
                    ) {
                        alert("A category with this name already exists.");
                        return;
                    }
                    const newCategory = {
                        id: crypto.randomUUID(),
                        name: categoryName,
                    };
                    data.categories.push(newCategory);
                    saveData();
                    addCategoryForm.reset();
                };

                const handleAddWord = (event) => {
                    event.preventDefault();
                    const categoryId = categorySelect.value;
                    const wordText = wordInput.value.trim();
                    const definitionText = definitionInput.value.trim();

                    if (
                        !categoryId ||
                        categorySelect.options[categorySelect.selectedIndex]
                            .disabled
                    ) {
                        alert("Please select a valid category.");
                        return;
                    }
                    if (wordText === "" || definitionText === "") {
                        alert("Word and definition cannot be empty.");
                        return;
                    }

                    const newWord = {
                        id: crypto.randomUUID(),
                        categoryId: categoryId,
                        word: wordText,
                        definition: definitionText,
                        createdAt: new Date().toISOString(),
                    };
                    data.words.unshift(newWord);
                    saveData();
                    addWordForm.reset();
                    // Keep category selected, focus on word input
                    categorySelect.value = categoryId;
                    wordInput.focus();
                };

                const handleListClick = (event) => {
                    const deleteBtn = event.target.closest(".delete-btn");
                    if (deleteBtn) {
                        const wordId = deleteBtn.getAttribute("data-word-id");
                        data.words = data.words.filter(
                            (word) => word.id !== wordId
                        );
                        saveData();
                    }
                };

                const handleExport = () => {
                    if (data.words.length === 0) {
                        alert("Nothing to export.");
                        return;
                    }
                    const csvString = dataToCsv();
                    const blob = new Blob([csvString], { type: "text/csv" });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement("a");
                    a.href = url;
                    a.download = `tres_cozy_words_${new Date()
                        .toISOString()
                        .slice(0, 10)}.csv`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                };

                const handleImport = (event) => {
                    const file = event.target.files[0];
                    if (!file) return;
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const importedData = csvToData(e.target.result);
                            data = importedData;
                            saveData();
                            alert(
                                `Successfully imported ${importedData.words.length} words into ${importedData.categories.length} categories! Existing data has been replaced.`
                            );
                        } catch (error) {
                            alert(`Error importing file: ${error.message}`);
                        } finally {
                            importFileInput.value = "";
                        }
                    };
                    reader.onerror = () => alert("Error reading file.");
                    reader.readAsText(file);
                };

                const handleDeckClick = (event) => {
                    const deck = event.target.closest(".category-deck");
                    if (deck) {
                        const categoryId = deck.dataset.categoryId;
                        const category = data.categories.find(
                            (c) => c.id === categoryId
                        );
                        currentReviewWords = data.words.filter(
                            (w) => w.categoryId === categoryId
                        );

                        flashcardCategoryTitle.textContent = `Reviewing: ${category.name}`;
                        showView(flashcardView);
                        showNextCard();
                    }
                };

                // --- NAVIGATION EVENT LISTENERS ---
                deckContainer.addEventListener("click", handleDeckClick);

                manageWordsDeck.addEventListener("click", () => {
                    showView(manageView);
                });

                [backToDashboardFlashcard, backToDashboardManage].forEach(
                    (btn) => {
                        btn.addEventListener("click", () =>
                            showView(dashboardView)
                        );
                    }
                );

                // --- FUNCTIONAL EVENT LISTENERS ---
                flashcard.addEventListener("click", () => {
                    flashcard.classList.toggle("is-flipped");
                });

                nextWordBtn.addEventListener("click", (e) => {
                    e.stopPropagation();
                    showNextCard();
                });

                addCategoryForm.addEventListener("submit", handleAddCategory);
                addWordForm.addEventListener("submit", handleAddWord);
                categoryListContainer.addEventListener(
                    "click",
                    handleListClick
                );
                exportBtn.addEventListener("click", handleExport);
                importFileInput.addEventListener("change", handleImport);

                // --- INITIALIZATION ---
                loadData();
                renderAll();
                showView(dashboardView);
            });
        </script>
    </body>
</html>
